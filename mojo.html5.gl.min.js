(function(){document.addEventListener("DOMContentLoaded",w,false);var v=3.141592653589793;var h=2*v;var u=v/2;var o=this.WebGL2D=function o(y){this.canvas=y;this.gl=undefined;this.fs=undefined;this.vs=undefined;this.shaderProgram=undefined;this.transform=new r();this.shaderPool=[];this.maxTextureSize=undefined;y.gl2d=this;y.$getContext=y.getContext;y.oGetContext=y.getContext;y.getContext=(function(z){return function(A){if(z.gl){return z.gl}if(A==="2d"&&!(y.width===0||y.height===0)){var D=z.gl=z.canvas.$getContext("webgl",{alpha:false})||z.canvas.$getContext("experimental-webgl",{alpha:false});if((typeof(D)==="undefined")||(D===null)){return z.canvas.$getContext("2d")}try{z.initShaders();z.initBuffers()}catch(C){var E=document.createElement("canvas");E.width=z.canvas.width;E.height=z.canvas.height;E.id=z.canvas.id;E.onclick=function(){this.focus()};var B=z.canvas.parentNode;B.removeChild(z.canvas);B.insertBefore(E,B.firstChild);window.onload();return E.getContext("2d")}z.initCanvas2DAPI();D.viewport(0,0,z.canvas.width,z.canvas.height);D.clearColor(0,0,0,1);D.clear(D.COLOR_BUFFER_BIT);D.enable(D.BLEND);D.blendFunc(D.SRC_ALPHA,D.ONE_MINUS_SRC_ALPHA);z.maxTextureSize=D.getParameter(D.MAX_TEXTURE_SIZE);gxtkGraphics.prototype.DrawSurface=function(G,F,H){if(!G.image.complete){return}this.gc.drawImage(G.image,F,H)};gxtkGraphics.prototype.DrawSurface2=function(G,F,L,I,H,J,K){if(!G.image.complete){return}if(J<0){I+=J;J=-J}if(K<0){H+=K;K=-K}if(J<=0||K<=0){return}this.gc.drawImage(G.image,I,H,J,K,F,L,J,K)};gxtkGraphics.prototype.SetScissor=function(F,I,G,H){if(F!==0||I!==0||G!==this.Width()||H!==this.Height()){D.enable(D.SCISSOR_TEST);I=this.Height()-I-H;D.scissor(F,I,G,H)}else{D.disable(D.SCISSOR_TEST)}};return D}else{return z.canvas.$getContext(A)}}}(this))};o.prototype.initCanvas2DAPI=function e(){var ac=this,V=this.gl;var H=1,N=1,y=1;var D=1,U="source-over";Object.defineProperty(V,"fillStyle",{get:function(){return""},set:function(ag){var af=ag.slice(4,-1).split(",");H=af[0]>=255?1:af[0]/255;N=af[1]>=255?1:af[1]/255;y=af[2]>=255?1:af[2]/255}});Object.defineProperty(V,"strokeStyle",{get:function(){return""},set:function(af){}});Object.defineProperty(V,"globalAlpha",{get:function(){return D},set:function(af){D=af}});Object.defineProperty(V,"globalCompositeOperation",{get:function(){return U},set:function(af){if(U===af){return}if(af==="lighter"){V.blendFunc(V.SRC_ALPHA,V.ONE)}else{V.blendFunc(V.SRC_ALPHA,V.ONE_MINUS_SRC_ALPHA)}U=af}});V.save=function Y(){ac.transform.pushMatrix()};V.restore=function X(){ac.transform.popMatrix()};V.translate=function O(af,ag){ac.transform.translate(af,ag)};V.rotate=function W(af){ac.transform.rotate(af)};V.scale=function ad(af,ag){ac.transform.scale(af,ag)};V.transform=function P(aj,ai,al,ak,ah,ag){var af=ac.transform.m_stack[ac.transform.c_stack];af[0]=aj;af[1]=ai;af[3]=al;af[4]=ak;af[6]=ah;af[7]=ag};function M(ai){var af=ac.transform.m_stack;for(var ah=0,ag=ac.transform.c_stack+1;ah<ag;++ah){V.uniformMatrix3fv(ai.uTransforms[ah],false,af[ag-1-ah])}}V.setTransform=function C(ai,ah,ak,aj,ag,af){ac.transform.setIdentity();V.transform.apply(this,arguments)};V.fillRect=function L(ag,ak,ai,af){var ah=ac.transform;var aj=ac.initShaders(ah.c_stack+2,0);V.bindBuffer(V.ARRAY_BUFFER,m);V.vertexAttribPointer(aj.vertexPositionAttribute,4,V.FLOAT,false,0,0);ah.pushMatrix();ah.translate(ag,ak);ah.scale(ai,af);M(aj);V.uniform4f(aj.uColor,H,N,y,D);V.drawArrays(V.TRIANGLE_FAN,0,4);ah.popMatrix()};var E=[];function K(af,ag){this.closed=false;this.verts=[af,ag,0,0]}V.beginPath=function ae(){E.length=0};V.closePath=function B(){if(E.length){var ah=E[E.length-1],ag=ah.verts[0],af=ah.verts[1];ah.closed=true;var ai=new K(ag,af);E.push(ai)}};V.moveTo=function R(af,ag){E.push(new K(af,ag))};V.lineTo=function Q(af,ag){if(E.length){E[E.length-1].verts.push(af,ag,0,0)}else{V.moveTo(af,ag)}};V.rect=function z(af,ai,ag,ah){V.moveTo(af,ai);V.lineTo(af+ag,ai);V.lineTo(af+ag,ai+ah);V.lineTo(af,ai+ah);V.closePath()};V.arc=function J(am,al,aj,ak,ag,ah){if(!E.length){V.moveTo(am,al+aj);var af=u*0.1;var an=E[0].verts;for(var ai=af;ai<h;ai+=af){an.push(am+Math.sin(ai)*aj,al+Math.cos(ai)*aj,0,0)}}else{var af=u*0.1;var an=E[E.length-1].verts;for(var ai=0;ai<360;ai+=af){an.push(am+Math.sin(ai)*aj,al+Math.cos(ai)*aj,0,0)}}};function Z(ah){var ag=ac.transform;var aj=ac.initShaders(ag.c_stack+2,0);var af=E[ah];var ai=af.verts;V.bindBuffer(V.ARRAY_BUFFER,f);V.bufferData(V.ARRAY_BUFFER,new Float32Array(ai),V.STATIC_DRAW);V.vertexAttribPointer(aj.vertexPositionAttribute,4,V.FLOAT,false,0,0);ag.pushMatrix();M(aj);V.uniform4f(aj.uColor,H,N,y,D);V.drawArrays(V.TRIANGLE_FAN,0,ai.length/4);ag.popMatrix()}V.fill=function T(){for(var af=0;af<E.length;af++){Z(af)}};function F(ah){var ag=ac.transform;var aj=ac.initShaders(ag.c_stack+2,0);var af=E[ah];var ai=af.verts;V.bindBuffer(V.ARRAY_BUFFER,f);V.bufferData(V.ARRAY_BUFFER,new Float32Array(ai),V.STATIC_DRAW);V.vertexAttribPointer(aj.vertexPositionAttribute,4,V.FLOAT,false,0,0);ag.pushMatrix();M(aj);V.uniform4f(aj.uColor,H,N,y,D);if(af.closed){V.drawArrays(V.LINE_LOOP,0,ai.length/4)}else{V.drawArrays(V.LINE_STRIP,0,ai.length/4)}ag.popMatrix()}V.stroke=function I(){for(var af=0;af<E.length;af++){F(af)}};V.clip=function aa(){};var G=[],ab=[];function A(ah){this.obj=V.createTexture();this.index=ab.push(this);var ai=(typeof(CFG_MOJO_IMAGE_FILTERING_ENABLED)==="undefined"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="true");G.push(ah);if(ah.width>ac.maxTextureSize||ah.height>ac.maxTextureSize){var ag=document.createElement("canvas");ag.width=(ah.width>ac.maxTextureSize)?ac.maxTextureSize:ah.width;ag.height=(ah.height>ac.maxTextureSize)?ac.maxTextureSize:ah.height;var af=ag.getContext("2d");af.drawImage(ah,0,0,ah.width,ah.height,0,0,ag.width,ag.height);ah=ag}V.bindTexture(V.TEXTURE_2D,this.obj);V.texImage2D(V.TEXTURE_2D,0,V.RGBA,V.RGBA,V.UNSIGNED_BYTE,ah);V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE);V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE);if(ai){V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MAG_FILTER,V.LINEAR)}else{V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MAG_FILTER,V.NEAREST)}if(k(ah.width)&&k(ah.height)){if(ai){V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.LINEAR_MIPMAP_LINEAR);V.generateMipmap(V.TEXTURE_2D)}else{V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.NEAREST_MIPMAP_NEAREST);V.generateMipmap(V.TEXTURE_2D)}}else{if(ai){V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.LINEAR)}else{V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.NEAREST)}}V.bindTexture(V.TEXTURE_2D,null)}V.drawImage=function S(ah,at,ar,ap,ao,am,al,ak,aj){var ag=ac.transform;ag.pushMatrix();var ai=i.texture;var au=false;if(arguments.length===3){ag.translate(at,ar);ag.scale(ah.width,ah.height)}else{if(arguments.length===5){ag.translate(at,ar);ag.scale(ap,ao)}else{if(arguments.length===9){ag.translate(am,al);ag.scale(ak,aj);ai=ai|i.crop;au=true}}}var af=ac.initShaders(ag.c_stack,ai);var an,aq=G.indexOf(ah);if(aq!==-1){an=ab[aq]}else{an=new A(ah)}if(au){V.uniform4f(af.uCropSource,at/ah.width,ar/ah.height,ap/ah.width,ao/ah.height)}V.bindBuffer(V.ARRAY_BUFFER,m);V.vertexAttribPointer(af.vertexPositionAttribute,4,V.FLOAT,false,0,0);V.bindTexture(V.TEXTURE_2D,an.obj);V.activeTexture(V.TEXTURE0);V.uniform1i(af.uSampler,0);M(af);V.uniform4f(af.uColor,H,N,y,D);V.drawArrays(V.TRIANGLE_FAN,0,4);ag.popMatrix()}};var i={texture:1,crop:2,path:4};o.prototype.getFragmentShaderSource=function d(z){var y=["#ifdef GL_ES","precision highp float;","#endif","#define hasTexture "+((z&i.texture)?"1":"0"),"#define hasCrop "+((z&i.crop)?"1":"0"),"varying vec4 vColor;","#if hasTexture","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","#if hasCrop","uniform vec4 uCropSource;","#endif","#endif","void main(void) {","#if hasTexture","#if hasCrop","gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy) * vColor;","#else","gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;","#endif","#else","gl_FragColor = vColor;","#endif","}"].join("\n");return y};o.prototype.getVertexShaderSource=function g(A,C){var z=2/this.canvas.width,B=-2/this.canvas.height;A=A||1;var y=["#define hasTexture "+((C&i.texture)?"1":"0"),"attribute vec4 aVertexPosition;","#if hasTexture","varying vec2 vTextureCoord;","#endif","uniform vec4 uColor;","uniform mat3 uTransforms["+A+"];","varying vec4 vColor;","const mat4 pMatrix = mat4("+z+",0,0,0, 0,"+B+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);","mat3 crunchStack(void) {","mat3 result = uTransforms[0];","for (int i = 1; i < "+A+"; ++i) {","result = uTransforms[i] * result;","}","return result;","}","void main(void) {","vec3 position = crunchStack() * vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = uColor;","#if hasTexture","vTextureCoord = aVertexPosition.zw;","#endif","}"].join("\n");return y};o.prototype.initShaders=function x(C,B){var D=this.gl;C=C||1;B=B||0;var z=this.shaderPool[C];if(!z){z=this.shaderPool[C]=[]}z=z[B];if(z){D.useProgram(z);this.shaderProgram=z;return z}else{var y=this.fs=D.createShader(D.FRAGMENT_SHADER);D.shaderSource(this.fs,this.getFragmentShaderSource(B));D.compileShader(this.fs);if(!D.getShaderParameter(this.fs,D.COMPILE_STATUS)){throw"fragment shader error: "+D.getShaderInfoLog(this.fs)}var F=this.vs=D.createShader(D.VERTEX_SHADER);D.shaderSource(this.vs,this.getVertexShaderSource(C,B));D.compileShader(this.vs);if(!D.getShaderParameter(this.vs,D.COMPILE_STATUS)){throw"vertex shader error: "+D.getShaderInfoLog(this.vs)}var E=this.shaderProgram=D.createProgram();E.stackDepth=C;D.attachShader(E,y);D.attachShader(E,F);D.linkProgram(E);if(!D.getProgramParameter(E,D.LINK_STATUS)){throw"Could not initialise shaders."}D.useProgram(E);E.vertexPositionAttribute=D.getAttribLocation(E,"aVertexPosition");D.enableVertexAttribArray(E.vertexPositionAttribute);E.uColor=D.getUniformLocation(E,"uColor");E.uSampler=D.getUniformLocation(E,"uSampler");E.uCropSource=D.getUniformLocation(E,"uCropSource");E.uTransforms=[];for(var A=0;A<C;++A){E.uTransforms[A]=D.getUniformLocation(E,"uTransforms["+A+"]")}this.shaderPool[C][B]=E;return E}};var m;var p;var f;var t;var n=new Float32Array([0,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0]);o.prototype.initBuffers=function s(){var y=this.gl;m=y.createBuffer();p=y.createBuffer();f=y.createBuffer();t=y.createBuffer();y.bindBuffer(y.ARRAY_BUFFER,m);y.bufferData(y.ARRAY_BUFFER,n,y.STATIC_DRAW)};function k(y){return y>0&&((y-1)&y)===0}var b={length:function(y){return Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2])},normalize:function(y){var z=Math.sqrt((y[0]*y[0])+(y[1]*y[1])+(y[2]*y[2]));if(z===0){return[0,0,0]}return[y[0]/z,y[1]/z,y[2]/z]},dot:function(z,y){return z[0]*y[0]+z[1]*y[1]+z[2]*y[2]},angle:function(z,y){return Math.acos((z[0]*y[0]+z[1]*y[1]+z[2]*y[2])/(Math.sqrt(z[0]*z[0]+z[1]*z[1]+z[2]*z[2])*Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2])))},cross:function(z,y){return[z[1]*y[2]-y[1]*z[2],z[2]*y[0]-y[2]*z[0],z[0]*y[1]-y[0]*z[1]]},multiply:function(z,y){return[z[0]*y,z[1]*y,z[2]*y]},add:function(z,y){return[z[0]+y[0],z[1]+y[1],z[2]+y[2]]},subtract:function(z,y){return[z[0]-y[0],z[1]-y[1],z[2]-y[2]]},equal:function(z,y){var A=1e-7;if((z===undefined)&&(y===undefined)){return true}if((z===undefined)||(y===undefined)){return false}return(Math.abs(z[0]-y[0])<A&&Math.abs(z[1]-y[1])<A&&Math.abs(z[2]-y[2])<A)}};var l={identity:[1,0,0,0,1,0,0,0,1],multiply:function(z,y){var R=z[0],Q=z[1],P=z[2],O=z[3],N=z[4],M=z[5],L=z[6],K=z[7],J=z[8],I=y[0],H=y[1],G=y[2],F=y[3],E=y[4],D=y[5],C=y[6],B=y[7],A=y[8];y[0]=I*R+F*Q+C*P;y[1]=H*R+E*Q+B*P;y[2]=G*R+D*Q+A*P;y[3]=I*O+F*N+C*M;y[4]=H*O+E*N+B*M;y[5]=G*O+D*N+A*M;y[6]=I*L+F*K+C*J;y[7]=H*L+E*K+B*J;y[8]=G*L+D*K+A*J},vec2_multiply:function(A,z){var y=[];y[0]=z[0]*A[0]+z[3]*A[1]+z[6];y[1]=z[1]*A[0]+z[4]*A[1]+z[7];return y},transpose:function(y){return[y[0],y[3],y[6],y[1],y[4],y[7],y[2],y[5],y[8]]}};function r(y){return this.clearStack(y)}var c=16;r.prototype.clearStack=function(y){this.m_stack=[];this.m_cache=[];this.c_stack=0;this.valid=0;this.result=null;for(var z=0;z<c;z++){this.m_stack[z]=this.getIdentity()}if(y!==undefined){this.m_stack[0]=y}else{this.setIdentity()}};r.prototype.setIdentity=function(){this.m_stack[this.c_stack]=this.getIdentity();if(this.valid===this.c_stack&&this.c_stack){this.valid--}};r.prototype.getIdentity=function(){return[1,0,0,0,1,0,0,0,1]};r.prototype.getResult=function(){if(!this.c_stack){return this.m_stack[0]}var y=l.identity;if(this.valid>this.c_stack-1){this.valid=this.c_stack-1}for(var z=this.valid;z<this.c_stack+1;z++){y=l.multiply(this.m_stack[z],y);this.m_cache[z]=y}this.valid=this.c_stack-1;this.result=this.m_cache[this.c_stack];return this.result};r.prototype.pushMatrix=function(){this.c_stack++;this.m_stack[this.c_stack]=this.getIdentity()};r.prototype.popMatrix=function(){if(this.c_stack===0){return}this.c_stack--};var q=r.prototype.getIdentity();r.prototype.translate=function(z,A){q[6]=z;q[7]=A;l.multiply(q,this.m_stack[this.c_stack])};var j=r.prototype.getIdentity();r.prototype.scale=function(z,A){j[0]=z;j[4]=A;l.multiply(j,this.m_stack[this.c_stack])};var a=r.prototype.getIdentity();r.prototype.rotate=function(y){var z,A;z=Math.sin(-y);A=Math.cos(-y);a[0]=A;a[3]=z;a[1]=-z;a[4]=A;l.multiply(a,this.m_stack[this.c_stack])};function w(){new o(document.getElementById("GameCanvas"))}})();